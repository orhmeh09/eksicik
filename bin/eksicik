#!/usr/bin/env python

import eksicik
import os
import argparse
abspath = os.path.dirname(os.path.abspath(__file__))

entries = []

parser = argparse.ArgumentParser()
parser.add_argument('-b', '--baslik', help=
                    '''cekilecek eksisozluk basligi.
                    urlde eksi sozluk linkinden sonra gelen kisim''', type=str)
parser.add_argument('-s', '--sayfa-araligi', help=
                    '''indirilecek sayfa araligi. ornek: "-s 1-10"
                    varolan sayfa sayisindan daha buyuk bir rakam girilirse
                    indirme islemi son sayfada duracaktir.''', type=str)
parser.add_argument('-o', '--output-file', help='cikti dosyasi', type=str)
parser.add_argument('-v', '--verbose', action='store_true')
parser.add_argument('-x', '--xml', help='output XML instead of the default JSON',
                    action='store_true')
# parser.add_argument('-j', '--json', help=
#                     '''output JSON. This is the default.
                    # Use with -x to output both XML and JSON''',
                    # action='store_true')

args = parser.parse_args()

# if args.xml:
    # eksicik.outputXml = True

# input file
if args.baslik:
    baslik = args.baslik
    if not args.output_file:
        if args.xml:
            outputFileName = 'default_out.xml'
        else:
            outputFileName = 'default_out.json'
    else:
        outputFileName = args.output_file
    sayfaAraligi = None
    if args.sayfa_araligi:
        sayfaAraligi = args.sayfa_araligi.split('-')

        for i,j in enumerate(sayfaAraligi):
            sayfaAraligi[i] = int(j)

        if len(sayfaAraligi) != 2:
            raise Exception("Gecersiz sayfa araligi:" + args.sayfa_araligi)
        elif sayfaAraligi[0] < 1:
            raise Exception("Gecersiz baslangic sayfasi: " + str(sayfaAraligi[0]))
        elif sayfaAraligi[1] < 1:
            raise Exception("Gecersiz bitis sayfasi: " + str(sayfaAraligi[1]))

    entries = eksicik.getAllEntriesFromBaslik(baslik, sayfaAraligi=sayfaAraligi)

    print("Indirilenler " + outputFileName + " dosyasina kaydediliyor")
    # Post process
    outputFile = open(outputFileName, 'w')

    for i in entries:
        if args.xml:
            outputFile.write(i.getXml())
        else:
            outputFile.write(i.getJson())

        outputFile.write("\n")

    outputFile.close()

    print("Bit")
else:
    parser.print_help()
